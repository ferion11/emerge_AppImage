#!/bin/bash -e
HERE="$(dirname "$(readlink -f "${0}")")"

if [ "$(id -u)" != 0 ]; then
	echo "* This AppImage need to be run with root!"
	exit 1
fi
#=================================================
have_dep() {
	command -v "$1" >/dev/null 2>&1
}
check_commands() {
	for cmd in "$@"; do
		if have_dep "${cmd}"; then
			echo "* command ${cmd} is installed!"
		else
			echo "* Your system does not have the command: ${cmd}. Please install it!"
			exit 1
		fi
	done
}
check_commands mount umount chroot
#=================================================
function cleanup {
	umount -f "${HERE}/lib/modules"
	umount -f "${HERE}/usr/src/linux"
	umount -f "${HERE}/dev/pts"
	umount -f "${HERE}/run"

	umount -f "${HERE}/tmp"
	umount -f "${HERE}/var"

	umount -f "${HERE}/mnt/host"

	umount -f "${HERE}/sys"
	umount -f "${HERE}/proc"
	umount -f "${HERE}/dev"
}
#-------
trap cleanup EXIT
#=================================================
mount --rbind /dev "${HERE}/dev"
mount --rbind /proc "${HERE}/proc"
mount --rbind /sys "${HERE}/sys"

mount --rbind / "${HERE}/mnt/host"

mount --rbind /var "${HERE}/var"
mount --rbind /tmp "${HERE}/tmp"

mount -t tmpfs -o nosuid,nodev,noexec,mode=755 none "${HERE}/run"
mount -o bind /dev/pts "${HERE}/dev/pts"
mount -o bind /usr/src/linux "${HERE}/usr/src/linux"
mount -o bind /lib/modules "${HERE}/lib/modules"
#=================================================
chroot ${HERE} ./emerge.sh $@
#=================================================
exit 0
